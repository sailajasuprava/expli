{% schema %}
{
  "name": "CrossTalk ‚Äì Translate",
  "target": "body",
  "settings": []
}
{% endschema %}

<style>
  #crosstalk-localization * {
    box-sizing: border-box !important;
  }

  #crosstalk-localization {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    z-index: 2147483647 !important; /* MAX z-index value */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    pointer-events: none !important;
  }

  #crosstalk-toggle {
    position: relative !important;
    width: 55px !important;
    height: 55px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border: none !important;
    color: white !important;
    font-size: 24px !important;
    cursor: pointer !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    pointer-events: auto !important;
    z-index: 2147483647 !important;
  }

  #crosstalk-toggle:hover {
    transform: scale(1.05) !important;
    box-shadow: 0 12px 35px rgba(0,0,0,0.2) !important;
  }

  #crosstalk-dropdown {
    position: fixed !important;
    bottom: 85px !important;
    right: 20px !important;
    width: 300px !important;
    max-height: 450px !important;
    background: rgba(255, 255, 255, 0.98) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 16px !important;
    box-shadow: 
      0 25px 50px -12px rgba(0,0,0,0.25),
      0 0 0 1px rgba(255,255,255,0.1) !important;
    overflow: hidden !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transform: translateY(20px) scale(0.95) !important;
    transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    z-index: 2147483647 !important;
    pointer-events: none !important;
  }

  #crosstalk-dropdown.open {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(0) scale(1) !important;
    pointer-events: auto !important;
  }

  #crosstalk-search {
    position: relative !important;
    width: 100% !important;
    padding: 18px 20px !important;
    border: none !important;
    border-bottom: 1px solid rgba(229, 231, 235, 0.8) !important;
    font-size: 14px !important;
    outline: none !important;
    background: transparent !important;
    z-index: 2147483647 !important;
  }

  #crosstalk-search::placeholder {
    color: #9ca3af !important;
  }

  #crosstalk-languages {
    position: relative !important;
    max-height: 350px !important;
    overflow-y: auto !important;
    scrollbar-width: thin !important;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent !important;
    z-index: 2147483647 !important;
  }

  #crosstalk-languages::-webkit-scrollbar {
    width: 4px !important;
  }

  #crosstalk-languages::-webkit-scrollbar-track {
    background: transparent !important;
  }

  #crosstalk-languages::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5) !important;
    border-radius: 2px !important;
  }

  .language-item {
    position: relative !important;
    padding: 16px 20px !important;
    cursor: pointer !important;
    border-bottom: 1px solid #f9fafb !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    z-index: 2147483647 !important;
  }

  .language-item:hover,
  .language-item.active {
    background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%) !important;
  }

  .language-flag {
    font-size: 20px !important;
    flex-shrink: 0 !important;
  }

  .language-name {
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #1f2937 !important;
  }

  #disable-translation {
    position: relative !important;
    padding: 16px 20px !important;
    background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%) !important;
    color: #dc2626 !important;
    cursor: pointer !important;
    border-top: 1px solid #fecaca !important;
    text-align: center !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    z-index: 2147483647 !important;
    transition: all 0.2s ease !important;
  }

  #disable-translation:hover {
    background: linear-gradient(90deg, #fee2e2 0%, #fecaca 100%) !important;
    transform: translateX(4px) !important;
  }

  /* Backdrop overlay for better isolation */
  #crosstalk-dropdown::before {
    content: '' !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: transparent !important;
    z-index: -1 !important;
  }
</style>


<div id="crosstalk-localization">
  <button id="crosstalk-toggle" title="Select Language">üåê</button>
  <div id="crosstalk-dropdown">
    <input 
      type="text" 
      id="crosstalk-search" 
      placeholder="Search languages..." 
    />
    <div id="crosstalk-languages">
      <!-- Languages populated by JS -->
    </div>
    <div id="disable-translation">
      ‚ùå Disable translation
    </div>
  </div>
</div>

<script>
  (function() {
    const languages = [
      { code: 'en', name: 'English üá∫üá∏', flag: 'üá∫üá∏' },
      { code: 'hi', name: '‡§π‡§ø‡§Ç‡§¶‡•Ä üáÆüá≥', flag: 'üáÆüá≥' },
      { code: 'es', name: 'Espa√±ol üá™üá∏', flag: 'üá™üá∏' },
      { code: 'fr', name: 'Fran√ßais üá´üá∑', flag: 'üá´üá∑' },
      { code: 'de', name: 'Deutsch üá©üá™', flag: 'üá©üá™' },
      { code: 'pt', name: 'Portugu√™s üáµüáπ', flag: 'üáµüáπ' },
      { code: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ© üá∏üá¶', flag: 'üá∏üá¶' },
      { code: 'zh-CN', name: '‰∏≠Êñá üá®üá≥', flag: 'üá®üá≥' },
      { code: 'ja', name: 'Êó•Êú¨Ë™û üáØüáµ', flag: 'üáØüáµ' },
      { code: 'ko', name: 'ÌïúÍµ≠Ïñ¥ üá∞üá∑', flag: 'üá∞üá∑' }
      // ... rest of your languages
    ];

    const localization = document.getElementById('crosstalk-localization');
    const toggle = document.getElementById('crosstalk-toggle');
    const dropdown = document.getElementById('crosstalk-dropdown');
    const search = document.getElementById('crosstalk-search');
    const languagesContainer = document.getElementById('crosstalk-languages');
    const disableBtn = document.getElementById('disable-translation');

    let currentLang = localStorage.getItem('crosstalk-lang') || 'en';

    // 1. SET COOKIE FUNCTION (The Secret Sauce)
    function setGoogleCookie(code) {
      const domain = window.location.hostname;
      const cookieValue = `/en/${code}`; // Format: /source_lang/target_lang
      
      // Set for both the current domain and the root domain to ensure coverage
      document.cookie = `googtrans=${cookieValue}; path=/; expires=Thu, 01 Jan 2070 00:00:00 UTC;`;
      document.cookie = `googtrans=${cookieValue}; domain=.${domain}; path=/; expires=Thu, 01 Jan 2070 00:00:00 UTC;`;
      
      // Reload is often necessary for Google Translate to pick up cookie changes reliably
      window.location.reload();
    }

    // 2. INITIALIZE GOOGLE TRANSLATE
    window.googleTranslateElementInit2 = function() {
      new window.google.translate.TranslateElement({
        pageLanguage: 'en',
        autoDisplay: false
      }, 'google_translate_element2');
    };

    function initGoogleTranslate() {
      const container = document.createElement('div');
      container.id = 'google_translate_element2';
      container.style.display = 'none';
      document.body.appendChild(container);

      const script = document.createElement('script');
      script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit2';
      script.async = true;
      document.head.appendChild(script);
    }

    // 3. SELECTION LOGIC
    function selectLanguage(code) {
      localStorage.setItem('crosstalk-lang', code);
      setGoogleCookie(code);
    }

    function disableTranslation() {
      localStorage.removeItem('crosstalk-lang');
      // Clearing the cookie
      document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      const domain = window.location.hostname;
      document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; domain=.${domain}; path=/;`;
      window.location.reload();
    }

    // 4. UI RENDERING
    function renderLanguages(filter = '') {
      languagesContainer.innerHTML = '';
      const filtered = languages.filter(lang => 
        lang.name.toLowerCase().includes(filter.toLowerCase())
      );
      filtered.forEach(lang => {
        const item = document.createElement('div');
        item.className = `language-item ${lang.code === currentLang ? 'active' : ''}`;
        item.innerHTML = `
          <span class="language-flag notranslate">${lang.flag}</span>
          <span class="language-name notranslate">${lang.name}</span>
        `;
        item.onclick = () => selectLanguage(lang.code);
        languagesContainer.appendChild(item);
      });
    }

    // EVENT LISTENERS
    toggle.onclick = () => {
      dropdown.classList.toggle('open');
      if (dropdown.classList.contains('open')) {
        renderLanguages();
        search.focus();
      }
    };

    search.oninput = (e) => renderLanguages(e.target.value);
    disableBtn.onclick = disableTranslation;

    document.addEventListener('click', (e) => {
      if (!localization.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });

    // START
    initGoogleTranslate();
    renderLanguages();
  })();
</script>
